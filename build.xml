<!--
 $Id$

 Notes:
   This script builds the CRM web application

   The easiest way to get started is to run "ant deploy"

   The build process will instruct you to have several environment variables
   and to customize the build.properties.  The build will fail until all
   installation conditions are met.

   Do not edit master.properties in this folder, a copy will be
   made by the installation and you will be notified of the file to modify.

   The build process needs write access to the destination web-app folder and
   the fileLibrary configured
-->
<project name="CRM" default="usage" basedir=".">

  <!-- enable environment variables -->
  <property environment="env"/>

  <!-- computed properties -->
  <property name="fs" value="${file.separator}"/>
  <property name="lf" value="${line.separator}"/>
  <property name="base.dir" value="${basedir}"/>
  <property name="bin.dir" value="${base.dir}${fs}bin"/>
  <property name="doc.dir" value="${base.dir}${fs}doc"/>
  <property name="lib.dir" value="${base.dir}${fs}lib"/>
  <property name="src.dir" value="${base.dir}${fs}src"/>
  <property name="src.classes.dir" value="${src.dir}${fs}java"/>
  <property name="src.web.dir" value="${src.dir}${fs}web"/>
  <property name="src.sql.dir" value="${src.dir}${fs}sql"/>
  <property name="build.dir" value="${base.dir}${fs}build"/>
  <property name="build.lib.dir" value="${build.dir}${fs}lib"/>
  <property name="build.classes.dir" value="${build.dir}${fs}classes"/>
  <property name="build.jsp.dir" value="${build.dir}${fs}jsp"/>
  <property name="build.jspclasses.dir" value="${build.dir}${fs}jspclasses"/>
  <property name="build.sql.dir" value="${build.dir}${fs}sql"/>
  <property name="build.docs.dir" value="${build.dir}${fs}docs"/>
  <property name="build.pref.dir" value="${build.dir}${fs}pref"/>
  <property name="pref.dir" value="${base.dir}${fs}pref"/>
  <property name="dist.dir" value="${base.dir}${fs}dist"/>
  <property name="unittests.src.dir" value="${src.dir}${fs}testcases"/>
  <property name="unittests.build.dir" value="${build.dir}${fs}testcases"/>
  <property name="unittests.build.classes.dir" value="${unittests.build.dir}${fs}classes"/>
  <property name="unittests.build.lib.dir" value="${unittests.build.dir}${fs}lib"/>
  <property name="unittests.reports.dir" value="${unittests.build.dir}${fs}results"/>
  <!-- Typical usage -->
  <target name="usage">
    <echo message="Further instructions will appear if settings are missing"/>
    <echo message=""/>
    <echo message="ant deploy: compile, build, copy, and generate web application (production)"/>
    <echo message="ant dev: same as deploy, but doesn't do a clean compile (development)"/>
    <echo message="ant installdb: create tables, insert base records and permissions into new database"/>
    <echo message="    install.database: just create the tables"/>
    <echo message="    install.help: just install the help contents"/>
    <echo message="ant upgradedb: upgrades database with a specified script file"/>
    <echo message="ant docs: generate JavaDocs for all packages"/>
    <echo message="ant test: compile deployed JSPs to check for errors"/>
    <echo message="ant package: generate a .war file for manual deployment"/>
    <echo message="ant clean: delete the temporary build folder used by the install"/>
    <echo message="ant ws: registers web services with apache axis webapp"/>
  </target>

  <!-- Environment variables must be set before continuing -->
  <target name="init.environment">
    <tstamp>
      <format property="date.short" pattern="yyyyMMdd-HHmmss"/>
    </tstamp>
    <tstamp>
      <format property="date.long" pattern="yyyy-MM-dd hh:mm:ss aa"/>
    </tstamp>
    <!-- log the build -->
    <record name="${base.dir}/build.log" append="no"/>
  </target>

  <!-- See if Apache Axis is available for Web Services -->
  <target name="init.axis" depends="init.axis.exists, init.axis.missing" if="AXIS_HOME">
    <echo message="Apache Axis: Web Service Provider Present. Centric Web Services will be available."/>
  </target>

  <target name="init.axis.exists">
    <property file="${base.dir}/home.properties"/>
    <condition property="AXIS_HOME" value="${env.AXIS_HOME}">
      <available file="${env.AXIS_HOME}"/>
    </condition>
  </target>

  <target name="init.axis.missing" unless="AXIS_HOME">
    <echo>
      Apache Axis: Web Service Provider Missing. Centric Web Services will not
      be available.
      Please refer to the readme file for instructions on enabling web services.
    </echo>
  </target>

  <!-- See if servlet API file exists -->
  <target name="init.servlet.type" depends="init.environment">
    <condition property="TYPE.CATALINA">
      <equals arg1="${WEBSERVER.TYPE}" arg2="catalina"/>
    </condition>
  </target>
  <!-- Tomcat -->
  <target name="init.servlet6.exists" depends="init.environment" if="TYPE.CATALINA">
    <available file="${CATALINA_HOME}/lib/servlet-api.jar" property="build.servlet6.present"/>
  </target>
  <target name="init.servlet6.set" depends="init.servlet6.exists" if="build.servlet6.present">
    <property name="servletJar" value="${CATALINA_HOME}${fs}lib${fs}servlet-api.jar"/>
    <property name="jspJar" value="${CATALINA_HOME}${fs}lib${fs}jsp-api.jar"/>
    <property name="namingJar" value="${CATALINA_HOME}${fs}lib${fs}catalina.jar"/>
    <echo message="Web Server: Tomcat 6.x"/>
  </target>

  <!-- See where the build.properties file exists -->
  <target name="init.buildfile.exists">
    <property file="${base.dir}/home.properties"/>
    <condition property="CENTRIC_HOME" value="${env.CENTRIC_HOME}">
      <available file="${env.CENTRIC_HOME}"/>
    </condition>
    <condition property="CENTRIC_FILELIBRARY" value="${env.CENTRIC_FILELIBRARY}">
      <available file="${env.CENTRIC_FILELIBRARY}"/>
    </condition>
    <fail unless="CENTRIC_HOME">Initialization aborted

      SOLUTION:

      Either...

      A. Use the home.properties file for this instance...

      1. Create a file called "home.properties" in this directory with the
      CENTRIC_HOME property:

      CENTRIC_HOME=/path/to/apache-tomcat/webapps/centric

      2. Create the directory and make sure file permissions are correct.

      or...

      B. Use environment variables

      1. Create an environment variable CENTRIC_HOME which points to Tomcat's
      Concourse Suite Community Edition webapp directory.

      Ex. "export CENTRIC_HOME=/path/to/apache-tomcat/webapps/centric"
      Ex. "Using System in Control Panel set CENTRIC_HOME=c:\Program
      Files\Apache Software Foundation\Tomcat 5.5\webapps"

      2. Create the directory and make sure file permissions are correct.

    </fail>
    <fail unless="CENTRIC_FILELIBRARY">Initialization aborted

      SOLUTION:

      Either...

      A. Use the home.properties file for this instance...

      1. Create a file called "home.properties" in this directory with the
      CENTRIC_FILELIBRARY property:

      CENTRIC_FILELIBRARY=/var/lib/centric_crm/fileLibrary
      CENTRIC_FILELIBRARY=/opt/centric_crm/fileLibrary
      CENTRIC_FILELIBRARY=/Library/Application\ Support/CentricCRM/fileLibrary"
      CENTRIC_FILELIBRARY=c:\CentricCRM\fileLibrary"

      2. Create the directory and make sure file permissions are correct.

      or...

      B. Use environment variables

      1. Create an environment variable CENTRIC_FILELIBRARY which points to
      Concourse Suite Community Edition's target fileLibrary.
      The fileLibrary should be separate from CENTRIC_HOME because it contains
      custom files for Concourse Suite Community Edition.

      Ex. "export CENTRIC_FILELIBRARY=/var/lib/centric_crm/fileLibrary"
      Ex. "export CENTRIC_FILELIBRARY=/Library/Application\
      Support/CentricCRM/fileLibrary"
      Ex. "Using System in Control Panel set
      CENTRIC_FILELIBRARY=c:\CentricCRM\fileLibrary"

      2. Create the directory and make sure file permissions are correct.

    </fail>
    <property name="build.config.filename" value="${CENTRIC_FILELIBRARY}/build.properties"/>
    <condition property="build.config.present">
      <and>
        <isset property="build.config.filename"/>
        <available file="${build.config.filename}" type="file"/>
      </and>
    </condition>
    <available file="${base.dir}/lib/activation-1.1.jar" property="build.lib.present"/>
  </target>

  <target name="init.buildfile.type" depends="init.buildfile.exists" unless="build.config.present">
    <echo message="Setting up the build.properties file for the first time..."/>
  </target>

  <target name="init.home.setup" depends="init.buildfile.type" unless="build.config.war">
    <!-- Check the current directory for a CENTRIC_HOME, else use the global variable -->
    <mkdir dir="${CENTRIC_HOME}/WEB-INF"/>
    <mkdir dir="${CENTRIC_FILELIBRARY}"/>
  </target>

  <!-- Create the properties file if not exists -->
  <target name="init.buildfile.create" depends="init.buildfile.exists, init.buildfile.type, init.home.setup" unless="build.config.present">
    <copy file="${base.dir}/master.properties" tofile="${build.config.filename}" overwrite="false"/>
    <available file="${build.config.filename}" property="build.config.present"/>
  </target>

  <!-- Load the properties for this system, stop here if not found -->
  <target name="init.loadproperties" depends="init.buildfile.create">
    <!-- IF src build.properties is newer than build.properties, abort now and have user update -->
    <uptodate property="build.config.uptodate" srcfile="${base.dir}/master.properties" targetfile="${build.config.filename}"/>
    <fail unless="build.config.uptodate">Initialization aborted

      The build.properties file might be out of date.
      Compare and update the site copy with the source template, making any
      necessary changes.

      Site File: ${build.config.filename}
      Source Template: master.properties
    </fail>
    <loadproperties srcFile="${build.config.filename}">
      <filterchain>
        <filterreader classname="org.apache.tools.ant.filters.StripLineComments">
          <param type="comment" value="#"/>
        </filterreader>
      </filterchain>
    </loadproperties>
    <fail unless="build.lib.present">Initialization aborted

      SOLUTION:

      Download the 3rd-party libraries and make sure they are available at
      ${lib.dir}${fs}, these are available as a separate download
    </fail>
    <fail unless="WEBSERVER.TYPE">Initialization aborted

      SOLUTION:

      Uncomment and edit the WEBSERVER.TYPE property in the build.properties
      file:

      ${build.config.filename}

    </fail>
    <!-- Use the environment variable if available -->
    <condition property="CATALINA_HOME" value="${env.CATALINA_HOME}">
      <and>
        <equals arg1="${WEBSERVER.TYPE}" arg2="catalina"/>
        <available file="${env.CATALINA_HOME}"/>
      </and>
    </condition>
    <condition property="SERVLET_CONTAINER_EXISTS">
      <and>
        <equals arg1="${WEBSERVER.TYPE}" arg2="catalina"/>
        <available file="${CATALINA_HOME}"/>
      </and>
    </condition>
    <fail>Initialization aborted
      <condition>
        <and>
          <not>
            <isset property="SERVLET_CONTAINER_EXISTS"/>
          </not>
          <equals arg1="${WEBSERVER.TYPE}" arg2="catalina"/>
        </and>
      </condition>
      SOLUTION:

      Either...

      1. Create a file called "home.properties" in this directory with the
      CATALINA_HOME property:

      CATALINA_HOME=/path/to/apache-tomcat

      or...

      2. Create an environment variable CATALINA_HOME which points to Tomcat's
      directory.

      Ex. "export CATALINA_HOME=/path/to/apache-tomcat"
      Ex. "Using System in Control Panel set CATALINA_HOME=c:\Program
      Files\Apache Software Foundation\Tomcat 5.5"
    </fail>
    <fail unless="build.config.present">Initialization aborted

      SOLUTION: Make sure this directory has permissions to write files, since
      the build.properties file was not created at ${build.config.filename}
    </fail>
    <fail unless="PROPERTIES">Initialization aborted

      SOLUTION: Edit the properties file at ${build.config.filename}, make sure
      to uncomment the PROPERTIES parameter at the top of the file
    </fail>
    <!-- temporarily default locale to system locale -->
    <condition property="LOCALE.NAME" value="${SYSTEM.LANGUAGE}">
      <isset property="SYSTEM.LANGUAGE"/>
    </condition>
    <fail unless="LOCALE.NAME">Initialization aborted

      SOLUTION: Edit the properties file at ${build.config.filename}, make sure
      to configure the SYSTEM.LANGUAGE parameter in this file
    </fail>
  </target>

  <!-- Copy the common jars -->
  <target name="init.classpath.uptodate" unless="build.config.war">
    <mkdir dir="${CENTRIC_HOME}/WEB-INF/lib"/>
    <copy todir="${CENTRIC_HOME}/WEB-INF/lib">
      <fileset dir="${lib.dir}">
        <include name="*.jar"/>
      </fileset>
    </copy>
  </target>

  <!-- Configure classpath as both object and a property -->
  <target name="init.classpath"
          depends="init.classpath.uptodate,init.servlet.type,init.servlet6.set">
    <path id="cfs2.classpath">
      <pathelement location="${servletJar}"/>
      <pathelement location="${jspJar}"/>
      <pathelement location="${namingJar}"/>
      <fileset dir="${lib.dir}">
        <include name="*.jar"/>
      </fileset>
    </path>
    <property name="CLASSPATH" refid="cfs2.classpath"/>
    <echo message="Class Dir: ${servletJar}"/>
  </target>

  <!-- Prepare ant for processing -->
  <target name="init" depends="init.loadproperties,init.classpath,init.axis" description="Verify system environment needed by install">
    <!-- Default properties if not otherwise specified in build.properties -->
    <property name="DEBUG" value="true"/>
    <property name="DEBUGLEVEL" value="lines,vars,source"/>
    <property name="build.config.filename" value="${base.dir}/build.properties"/>
    <property name="build.config.present" value="ERROR: UNDEFINED"/>
    <property name="SYSTEM.LANGUAGE" value=""/>
    <!-- Gatekeeper database -->
    <property name="GATEKEEPER.APPCODE" value=""/>
    <property name="GATEKEEPER.DBTYPE" value=""/>
    <property name="GATEKEEPER.DRIVER" value=""/>
    <property name="GATEKEEPER.URL" value=""/>
    <property name="GATEKEEPER.USER" value=""/>
    <property name="GATEKEEPER.PASSWORD" value=""/>
    <!-- Additional sites/databases -->
    <property name="SITE.APPCODE" value=""/>
    <property name="SITE.DBTYPE" value=""/>
    <property name="SITE.DRIVER" value=""/>
    <property name="SITE.URL" value=""/>
    <property name="SITE.APPEND" value=""/>
    <property name="SITE.USER" value=""/>
    <property name="SITE.PASSWORD" value=""/>
    <!-- External Servers -->
    <property name="MAILSERVER" value="127.0.0.1"/>
    <property name="FAXSERVER" value="127.0.0.1"/>

    <!-- Begin output -->
    <echo message="Project: ${ant.project.name}"/>
    <echo message="Date: ${date.long}"/>
    <echo message="User: ${user.name}"/>
    <echo message="System: ${os.name} ${os.arch} ${os.version}"/>
    <echo message="Ant version: ${ant.version}"/>
    <echo message="Java version: ${java.version}"/>
    <echo message="Container Type: ${WEBSERVER.TYPE}"/>
    <echo message="Source path: ${base.dir}"/>
    <echo message="Destination path: ${CENTRIC_HOME}"/>
    <echo message="Properties file: ${build.config.filename}"/>
    <echo message="File Library path: ${CENTRIC_FILELIBRARY}"/>
    <echo message="Locale: ${LOCALE.NAME}"/>

  </target>

  <target name="taskdef.upgradeDatabase" depends="init">
    <taskdef name="upgradeDatabase" classname="org.aspcfs.ant.tasks.UpgradeDatabaseTask">
      <classpath>
        <fileset dir="${build.lib.dir}">
          <include name="*.jar"/>
        </fileset>
        <fileset dir="${lib.dir}">
          <include name="*.jar"/>
        </fileset>
      </classpath>
    </taskdef>
  </target>

  <target name="taskdef.jasper" depends="init">
    <taskdef name="compileJasperReport" classname="net.sf.jasperreports.ant.JRAntCompileTask">
      <classpath>
        <fileset dir="${build.lib.dir}">
          <include name="*.jar"/>
        </fileset>
        <fileset dir="${lib.dir}">
          <include name="*.jar"/>
        </fileset>
      </classpath>
    </taskdef>
  </target>

  <!-- See if files are up-to-date so only new files are installed during development -->
  <target name="classes.prepare" depends="init" unless="build.config.war">
    <uptodate property="classes.uptodate">
      <srcfiles dir="${src.classes.dir}" includes="**/*.java log4j.properties"/>
      <mapper type="merge" to="${CENTRIC_HOME}/WEB-INF/lib/aspcfs.jar"/>
    </uptodate>
  </target>

  <!-- Check to see if previously compiled classes should be deleted -->
  <target name="compile.checkdelete" depends="init">
    <condition property="compile.donotdelete">
      <isset property="classes.uptodate"/>
    </condition>
    <condition property="compile.donotdelete">
      <and>
        <not>
          <isset property="classes.uptodate"/>
        </not>
        <isset property="compile.donotdelete.property"/>
      </and>
    </condition>
  </target>

  <target name="compile.delete" depends="init,compile.checkdelete" unless="compile.donotdelete">
    <!-- Get rid of any classes in the source dir that shouldn't be there -->
    <delete>
      <fileset dir="${src.classes.dir}" includes="**/*.class"/>
    </delete>
    <delete dir="${build.classes.dir}"/>
    <mkdir dir="${build.classes.dir}"/>
  </target>

  <!-- Compile the Java source code -->
  <target name="compile" description="Compile all .java source files" depends="init,compile.delete" unless="classes.uptodate">
    <!-- Compile the code -->
    <javac srcdir="${src.classes.dir}" destdir="${build.classes.dir}" 
           verbose="off" 
           deprecation="on" 
           optimize="on" 
           source="10" target="10"
           includeantruntime="true"
           debug="off">
      <classpath>
        <path refid="cfs2.classpath"/>
      </classpath>
    </javac>
    <!-- copy log4j file properties-->
    <copy todir="${build.classes.dir}">
      <fileset dir="${src.classes.dir}">
        <include name="log4j.properties"/>
      </fileset>
    </copy>
  </target>

  <!-- Generate the .jar files -->
  <target name="jar" depends="init" unless="classes.uptodate">
    <delete dir="${build.lib.dir}"/>
    <mkdir dir="${build.lib.dir}"/>
    <!-- darkhorseventures.jar -->
    <jar jarfile="${build.lib.dir}/darkhorseventures.jar" basedir="${build.classes.dir}" includes="com/darkhorseventures/**/*.class"/>
    <!-- isavvix.jar -->
    <jar jarfile="${build.lib.dir}/isavvix.jar" basedir="${build.classes.dir}" includes="com/isavvix/**/*.class"/>
    <!-- Novacoast.jar -->
    <jar jarfile="${build.lib.dir}/Novacoast.jar" basedir="${build.classes.dir}" includes="com/Novacoast/**/*.class"/>
    <!-- zeroio-iteam.jar -->
    <jar jarfile="${build.lib.dir}/zeroio-iteam.jar" basedir="${build.classes.dir}" includes="com/zeroio/**/*.class"/>
    <!-- aspcfs.jar -->
    <jar jarfile="${build.lib.dir}/aspcfs.jar" basedir="${build.classes.dir}" includes="org/aspcfs/**/*.class log4j.properties"/>
    <!-- jcrontab.jar -->
    <jar jarfile="${build.lib.dir}/jcrontab.jar" basedir="${build.classes.dir}" includes="org/jcrontab/**/*.class"/>
    <!-- webdav.jar -->
    <copy todir="${build.classes.dir}/org/apache/catalina/servlets">
      <fileset dir="${src.classes.dir}/org/apache/catalina/servlets">
        <include name="LocalStrings.properties"/>
      </fileset>
    </copy>
    <jar jarfile="${build.lib.dir}/webdav.jar" basedir="${build.classes.dir}" includes="org/apache/**/*.class,org/apache/**/*.properties"/>
  </target>

  <target name="build" description="Create .jar files for compiled classes" depends="init,compile,jar">
    <mkdir dir="${build.lib.dir}"/>
  </target>

  <!-- Delete outdated files -->
  <target name="deploy.delete" description="Removes outdated files from web application" unless="build.config.war">
    <delete verbose="true">
      <fileset dir="${CENTRIC_HOME}" includesfile="${base.dir}/build.cleanup"/>
    </delete>
  </target>

  <target name="deploy.copy.axis" if="AXIS_HOME">
    <!-- Copy the .jars, to axis webapp if axis info present -->
    <copy todir="${AXIS_HOME}/WEB-INF/lib">
      <fileset dir="${build.lib.dir}">
        <include name="aspcfs.jar"/>
        <include name="darkhorseventures.jar"/>
        <include name="zeroio-iteam.jar"/>
      </fileset>
      <fileset dir="${lib.dir}">
        <include name="*.jar"/>
      </fileset>
    </copy>
  </target>

  <target name="deploy.copy" unless="build.config.war">
    <!-- Copy the About This Software reference file -->
    <copy file="${base.dir}/pref/cfs/source/readme-libraries.txt"
          todir="${CENTRIC_HOME}/WEB-INF"/>

    <!-- Copy the .jars, only if new -->
    <copy todir="${CENTRIC_HOME}/WEB-INF/lib">
      <fileset dir="${build.lib.dir}">
        <include name="*.jar"/>
      </fileset>
    </copy>
    <!-- Copy the web data, only if new -->
    <copy todir="${CENTRIC_HOME}">
      <fileset dir="${src.web.dir}/jsp">
        <include name="**"/>
      </fileset>
    </copy>
    <copy todir="${CENTRIC_HOME}">
      <fileset dir="${src.web.dir}/html">
        <include name="**"/>
      </fileset>
    </copy>
    <copy todir="${CENTRIC_HOME}">
      <fileset dir="${src.web.dir}">
        <include name="images/**"/>
        <include name="javascript/**"/>
        <include name="css/**"/>
      </fileset>
    </copy>
    <!-- Copy the configuration files -->
    <copy todir="${CENTRIC_HOME}/WEB-INF" verbose="true">
      <fileset dir="${src.web.dir}/WEB-INF">
        <include name="*.xml"/>
        <include name="*.tld"/>
        <exclude name="web.xml"/>
      </fileset>
    </copy>
    <!-- Copy the object mappings file -->
    <copy file="${pref.dir}/cfs/transfer/import-mappings.xml"
          todir="${CENTRIC_HOME}/WEB-INF" verbose="true"/>


    <!-- Copy the default preference files -->
    <mkdir dir="${CENTRIC_HOME}/WEB-INF/setup/init/"/>
    <copy todir="${CENTRIC_HOME}/WEB-INF/setup/init/" verbose="true">
      <fileset dir="${pref.dir}/cfs/system">
        <include name="*.xml"/>
      </fileset>
    </copy>

    <!-- Copy the dictionary files -->
    <mkdir dir="${CENTRIC_HOME}/WEB-INF/languages"/>
    <copy todir="${CENTRIC_HOME}/WEB-INF/languages">
      <fileset dir="${src.dir}/languages">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <mkdir dir="${CENTRIC_HOME}/javascript/languages"/>
    <copy todir="${CENTRIC_HOME}/javascript/languages">
      <fileset dir="${src.dir}/languages">
        <include name="*.js"/>
      </fileset>
    </copy>
    <!-- Copy the font files-->
    <mkdir dir="${CENTRIC_HOME}/WEB-INF/fonts"/>
    <copy todir="${CENTRIC_HOME}/WEB-INF/fonts">
      <fileset dir="${src.dir}/fonts">
        <include name="*.ttf"/>
      </fileset>
    </copy>
  </target>

  <target name="deploy.jasper.check" depends="init" unless="build.config.war">
    <uptodate property="deploy.jasper.uptodate">
      <srcfiles dir="${src.dir}/jasper_reports" includes="*.xml"/>
      <mapper type="merge" to="${CENTRIC_HOME}/WEB-INF/reports/accounts_type.jasper"/>
    </uptodate>
  </target>

  <target name="deploy.jasper.status.war" if="build.config.war">
    <property name="deploy.jasper.uptodate" value="true"/>
  </target>

  <target name="deploy.jasper.status" depends="deploy.jasper.check,taskdef.jasper,deploy.jasper.status.war" unless="deploy.jasper.uptodate">
    <echo message="Installing JasperReport files"/>
    <!-- Copy the jasperreports, only if new -->
    <copy todir="${CENTRIC_HOME}/WEB-INF/reports">
      <fileset dir="${src.dir}/jasper_reports">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <!-- The old .jasper file must be removed when a new .xml is copied -->
    <delete>
      <fileset dir="${CENTRIC_HOME}/WEB-INF/reports" includes="*.jasper"/>
    </delete>
    <!-- Compile the reports -->
   <!-- @todo fails
    <compileJasperReport srcdir="${CENTRIC_HOME}/WEB-INF/reports" destdir="${CENTRIC_HOME}/WEB-INF/reports"/>
   --> 
  </target>

  <target name="deploy.jasper" depends="deploy.jasper.status" unless="build.config.war">

  </target>

  <!-- See if there is an updated file to merge -->
  <target name="deploy.merge.prepare" unless="build.config.war">
    <!-- Generate a new CENTRIC_HOME web.xml if any of the following: -->
    <!-- 1. cvs web.xml is newer than CENTRIC_HOME web.xml -->
    <!-- 2. build.properties is newer than the installed web.xml -->
    <!-- 3. Any of the CENTRIC_HOME xml or tld files are newer than CENTRIC_HOME web.xml -->
    <condition property="deploy.merge.uptodate">
      <and>
        <available file="${CENTRIC_HOME}/WEB-INF/web.xml"/>
        <available file="${build.config.filename}"/>
        <uptodate srcfile="${src.web.dir}/WEB-INF/web.xml" targetfile="${CENTRIC_HOME}/WEB-INF/web.xml"/>
        <uptodate srcfile="${build.config.filename}" targetfile="${CENTRIC_HOME}/WEB-INF/web.xml"/>
        <uptodate targetfile="${CENTRIC_HOME}/WEB-INF/web.xml">
          <srcfiles dir="${CENTRIC_HOME}/WEB-INF" includes="*.xml,*.tld" excludes="web.xml"/>
        </uptodate>
      </and>
    </condition>
  </target>

  <target name="deploy.merge.status" if="build.config.war">
    <property name="deploy.merge.uptodate" value="true"/>
  </target>

  <!-- Merge meta-data with build.properties, only if changed so reload doesn't kick in -->
  <target name="deploy.status" depends="deploy.merge.prepare, deploy.merge.status" unless="deploy.merge.uptodate">
    <echo message="Installing web.xml configuration file"/>
    <copy file="${src.web.dir}/WEB-INF/web.xml" todir="${CENTRIC_HOME}/WEB-INF" overwrite="true"/>
    <replace file="${CENTRIC_HOME}/WEB-INF/web.xml" token="@KEYSTORE@" value="${CENTRIC_FILELIBRARY}${fs}keystore"/>
  </target>

  <target name="deploy.merge" depends="deploy.status" unless="build.config.war">

  </target>

  <!-- Log the deployment process to the web-app folder -->
  <target name="log.deploy" depends="init.loadproperties" unless="build.config.war">
    <mkdir dir="${CENTRIC_HOME}/WEB-INF/logs"/>
    <record name="${CENTRIC_HOME}/WEB-INF/logs/deploy-${date.short}.log" append="no"/>
  </target>

  <target name="log.upgradedb" depends="init.loadproperties" unless="build.config.war">
    <mkdir dir="${CENTRIC_HOME}/WEB-INF/logs"/>
    <record name="${CENTRIC_HOME}/WEB-INF/logs/upgradedb-${date.short}.log" append="no"/>
  </target>

  <target name="log.installdb" depends="init.loadproperties" unless="build.config.war">
    <mkdir dir="${CENTRIC_HOME}/WEB-INF/logs"/>
    <record name="${CENTRIC_HOME}/WEB-INF/logs/installdb-${date.short}.log" append="no"/>
  </target>

  <!-- Check if keyfile exists -->
  <target name="keyfile.exists" depends="init" unless="build.config.war">
    <available file="${CENTRIC_FILELIBRARY}/keystore" property="keyfile.present"/>
  </target>

  <target name="keyfile.status" if="build.config.war">
    <property name="keyfile.present" value="true"/>
  </target>

  <!-- Generate SSL keyfile for new system -->
  <target name="keyfile.create" depends="keyfile.exists,keyfile.status" unless="keyfile.present">
    <echo message="Self-signed SSL certificate will be placed at ${CENTRIC_FILELIBRARY}/keystore"/>
    <genkey alias="centric_crm" keystore="${CENTRIC_FILELIBRARY}/keystore" storepass="centric_crm" storetype="JKS" keyalg="RSA" keysize="1024" validity="${KEYSTORE.VALIDITY}">
      <dname>
        <param name="CN" value="${KEYSTORE.COMMONNAME}"/>
        <param name="OU" value="${KEYSTORE.ORGANIZATIONALUNIT}"/>
        <param name="O" value="${KEYSTORE.ORGANIZATION}"/>
        <param name="L" value="${KEYSTORE.CITY}"/>
        <param name="ST" value="${KEYSTORE.STATE}"/>
        <param name="C" value="${KEYSTORE.COUNTRY}"/>
      </dname>
    </genkey>
    <!-- Prepare a CSR to get signed
    keytool -certreq -keyalg RSA -alias centric_crm -file ${CENTRIC_FILELIBRARY}/domain.csr -keystore ${CENTRIC_FILELIBRARY}/keystore
    -->
    <!-- Import the signed certificates
    keytool -import -trustcacerts -alias root -file GTECyberTrustRoot.crt -keystore ${CENTRIC_FILELIBRARY}/keystore
    keytool -import -trustcacerts -alias comodo -file ComodoSecurityServicesCA.crt -keystore ${CENTRIC_FILELIBRARY}/keystore
    keytool -import -trustcacerts -alias centric_crm -file domain.crt -keystore ${CENTRIC_FILELIBRARY}/keystore
    -->
    <!-- Export the certificate for a client app to use
    keytool -export -alias centric_crm -file ${CENTRIC_FILELIBRARY}/domain.cert -keystore ${CENTRIC_FILELIBRARY}/keystore
    -->
  </target>

  <target name="keyfile" depends="keyfile.create" unless="build.config.war">

  </target>

  <!-- Copy all data to the web-app folder and finalize any items -->
  <target name="deploy"
          description="Compile, build, copy, and configure web application"
          depends="log.deploy,classes.prepare,build,keyfile,deploy.delete,deploy.copy,deploy.copy.axis,deploy.merge,deploy.jasper,war.create">

  </target>

  <target name="dev.configure">
    <property name="compile.donotdelete.property" value="true"/>
    <property name="DEBUG" value="true"/>
    <property name="DEBUGLEVEL" value="lines,vars,source"/>
  </target>

  <target name="dev" description="Deploy without deleting previously compiled source" depends="dev.configure,deploy">
  </target>

  <!-- Generate .java/.class files out of the web-app .jsps -->
  <target name="test" depends="init,deploy" description="Compile deployed JSPs to check for errors">
    <delete dir="${build.jsp.dir}"/>
    <delete dir="${build.jspclasses.dir}"/>
    <echo message=""/>
    <echo message="Converting JSPs to Class files..."/>
    <mkdir dir="${build.jsp.dir}"/>
    <java classname="org.apache.jasper.JspC" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <pathelement location="${env.ANT_HOME}/lib/ant.jar"/>
        <fileset dir="${CATALINA_HOME}${fs}common${fs}lib">
          <include name="*.jar"/>
        </fileset>
        <fileset dir="${CATALINA_HOME}${fs}server${fs}lib">
          <include name="*.jar"/>
        </fileset>
      </classpath>
      <arg line="-v -d ${build.jsp.dir}
                -l -s
                -webapp ${CENTRIC_HOME} "/>
    </java>
    <echo message=""/>
    <echo message="Compiling JSP Class files..."/>
    <mkdir dir="${build.jspclasses.dir}"/>
    <javac srcdir="${build.jsp.dir}" destdir="${build.jspclasses.dir}" verbose="off" deprecation="on">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${CATALINA_HOME}${fs}common${fs}lib">
          <include name="*.jar"/>
        </fileset>
        <pathelement
            location="${CENTRIC_HOME}/WEB-INF/lib/darkhorseventures.jar"/>
        <pathelement location="${CENTRIC_HOME}/WEB-INF/lib/aspcfs.jar"/>
        <pathelement location="${CENTRIC_HOME}/WEB-INF/lib/zeroio-iteam.jar"/>
        <pathelement location="${CENTRIC_HOME}/WEB-INF/lib/isavvix.jar"/>
        <pathelement location="${CENTRIC_HOME}/WEB-INF/lib/Novacoast.jar"/>
        <pathelement location="${CENTRIC_HOME}/WEB-INF/lib/jcrontab.jar"/>
        <pathelement location="${CENTRIC_HOME}/WEB-INF/lib/webdav.jar"/>
      </classpath>
      <include name="**/*.java"/>
      <exclude name="**/*finclude_jsp.java"/>
      <exclude name="**/*fheader_005finclude*_jsp.java"/>
      <exclude name="**/*layout_005f*_jsp.java"/>
      <exclude name="**/*fmenu_jsp.java"/>
      <exclude name="**/*frelationships_*fview2_jsp.java"/>
    </javac>
  </target>

  <!-- Create a WAR -->
  <target name="war.create"
          depends="classes.prepare,build,dist.archive">
  </target>

  <target name="war.setup">
    <property name="build.config.war" value="true"/>
    <property name="archive.filename" value="crm.zip"/>
  </target>

  <target name="package"
          description="Compile, build, and generate web archive"
          depends="war.setup,war.create">
  </target>

  <target name="offline.setup">
    <property name="build.config.war" value="true"/>
    <property name="for.offline" value="true"/>
    <property name="archive.filename" value="centric_war_offline.zip"/>
  </target>

  <target name="offline"
          description="Compile, build, and generate offline web archive"
          depends="offline.setup,war.create">
  </target>

  <target name="dist.archive" depends="taskdef.jasper" if="build.config.war">
    <delete dir="${dist.dir}"/>
    <mkdir dir="${dist.dir}"/>
    <!-- Copy the common .jars -->
    <copy todir="${dist.dir}/cfs/WEB-INF/lib">
      <fileset dir="${lib.dir}">
        <include name="*.jar"/>
        <exclude name="commons-logging*.jar" if="for.offline"/>
        <exclude name="log4j-*.jar" if="for.offline"/>
        <exclude name="postgresql-*.jar" if="for.offline"/>
      </fileset>
    </copy>
    <!-- Copy the .jars -->
    <copy todir="${dist.dir}/cfs/WEB-INF/lib">
      <fileset dir="${build.lib.dir}">
        <include name="*.jar"/>
        <exclude name="aspcfs.jar"/>
        <exclude name="webdav.jar" if="for.offline"/>
      </fileset>
    </copy>
    <!-- aspcfs.jar -->
    <jar jarfile="${dist.dir}/cfs/WEB-INF/lib/aspcfs.jar"
         basedir="${build.classes.dir}"
         includes="org/aspcfs/**/*.class log4j.properties"/>
    <!-- Copy the web data -->
    <copy todir="${dist.dir}/cfs">
      <fileset dir="${src.web.dir}/jsp">
        <include name="**"/>
      </fileset>
    </copy>
    <copy todir="${dist.dir}/cfs">
      <fileset dir="${src.web.dir}/html">
        <include name="**"/>
      </fileset>
    </copy>
    <copy todir="${dist.dir}/cfs">
      <fileset dir="${src.web.dir}">
        <include name="images/**"/>
        <include name="javascript/**"/>
        <include name="css/**"/>
      </fileset>
    </copy>
    <!-- Copy the configuration files -->
    <copy todir="${dist.dir}/cfs/WEB-INF" verbose="true">
      <fileset dir="${src.web.dir}/WEB-INF">
        <include name="*.xml"/>
        <include name="*.tld"/>
        <exclude name="web.xml"/>
      </fileset>
    </copy>
    <!-- Copy the object mappings file -->
    <copy todir="${dist.dir}/cfs/WEB-INF"
          file="${pref.dir}/cfs/transfer/import-mappings.xml" verbose="true"/>
    <!-- Copy the default preference files -->
    <copy todir="${dist.dir}/cfs/WEB-INF/setup/init" verbose="true">
      <fileset dir="${pref.dir}/cfs/system">
        <include name="*.xml"/>
      </fileset>
    </copy>

    <!-- Copy the database files (all databases) -->
    <copy todir="${dist.dir}/cfs/WEB-INF/setup">
      <fileset dir="${src.sql.dir}">
        <exclude name="upgrade/**"/>
        <exclude name="init/**"/>
        <!-- Drop if="for.offline" for exclude DB scripts from war -->
        <exclude name="postgresql/**" if="for.offline"/>
        <include name="**/*"/>
      </fileset>
    </copy>

    <!-- Copy the database upgrade files -->
    <copy todir="${dist.dir}/cfs/WEB-INF/setup/upgrade">
      <fileset dir="${src.sql.dir}/upgrade">
        <include name="*.bsh"/>
      </fileset>
    </copy>
    <!-- Copy the database install files -->
    <copy todir="${dist.dir}/cfs/WEB-INF/setup/init">
      <fileset dir="${src.sql.dir}/init">
        <include name="*.bsh"/>
        <include name="*.xml"/>
      </fileset>
    </copy>
    <copy file="${src.sql.dir}/init/help.xml"
          todir="${dist.dir}/cfs/WEB-INF/setup/init"/>
    <!-- Copy the instance property -->
    <copy file="${pref.dir}/cfs/war/instance.property"
          todir="${dist.dir}/cfs/WEB-INF"/>
    <!-- Copy the .zipped portal templates -->
    <mkdir dir="${dist.dir}/cfs/WEB-INF/portal_templates"/>
    <copy todir="${dist.dir}/cfs/WEB-INF/portal_templates">
      <!-- Unzipped files: <fileset dir="${src.dir}/portal_templates"> -->
      <fileset dir="${CENTRIC_HOME}/WEB-INF/portal_templates">
        <include name="**/*"/>
      </fileset>
    </copy>
    <!-- Copy and compile the reports -->
    <!--
    <mkdir dir="${dist.dir}/cfs/WEB-INF/reports"/>
    <copy todir="${dist.dir}/cfs/WEB-INF/reports">
      <fileset dir="${src.dir}/jasper_reports">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <compileJasperReport
        srcdir="${dist.dir}/cfs/WEB-INF/reports"
        destdir="${dist.dir}/cfs/WEB-INF/reports"/>
    <delete>
      <fileset dir="${dist.dir}/cfs/WEB-INF/reports" includes="*.xml"/>
    </delete>
    -->
    <!-- Copy the language files -->
    <mkdir dir="${dist.dir}/cfs/WEB-INF/languages"/>
    <copy todir="${dist.dir}/cfs/WEB-INF/languages">
      <fileset dir="${src.dir}/languages">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <mkdir dir="${dist.dir}/cfs/javascript/languages"/>
    <copy todir="${dist.dir}/cfs/javascript/languages">
      <fileset dir="${src.dir}/languages">
        <include name="*.js"/>
      </fileset>
    </copy>
    <!-- Copy the fonts -->
    <mkdir dir="${dist.dir}/cfs/WEB-INF/fonts"/>
    <copy todir="${dist.dir}/cfs/WEB-INF/fonts">
      <fileset dir="${src.dir}/fonts">
        <include name="*.ttf"/>
      </fileset>
    </copy>
    <!-- Archive the folder -->
    <war destfile="${dist.dir}/crm.war"
         webxml="${src.web.dir}/WEB-INF/web.xml"
         basedir="${dist.dir}/cfs"
         compress="true"
         manifest="${pref.dir}/cfs/war/MANIFEST.MF"
        />
    <!-- Create the distributable .zip file -->
    <zip destfile="${dist.dir}/${archive.filename}">
      <fileset dir="${doc.dir}" includes="Binary*EULA.rtf"/>
      <fileset dir="${doc.dir}" includes="CRM*Installation*and*Setup.pdf"/>
      <fileset dir="${base.dir}" includes="CHANGES.txt"/>
      <fileset dir="${dist.dir}" includes="crm.war"/>
    </zip>
    <!-- Cleanup files -->
    <delete dir="${dist.dir}/cfs"/>
    <echo message=".war file created: ${dist.dir}${fs}crm.war"/>
  </target>

  <!-- Create sourcecode distribution -->
  <target name="source" description="Compile, build, and generate source archive" depends="deploy,source.archive">
  </target>

  <target name="source.archive">
    <property name="zip.dir" value="centric_crm"/>
    <delete dir="${dist.dir}"/>
    <mkdir dir="${dist.dir}"/>
    <!-- Update the build number -->
    <copy file="${base.dir}/README.txt" todir="${dist.dir}" verbose="true"/>
    <copy file="${base.dir}/pref/cfs/source/readme-libraries.txt" todir="${dist.dir}" verbose="true"/>
    <buildnumber file="source.number"/>
    <replace file="${dist.dir}/README.txt" token="@BUILD.NUMBER@" value="${build.number}"/>
    <replace file="${dist.dir}/README.txt" token="@BUILD.DATE@" value="${date.long}"/>
    <replace file="${dist.dir}/readme-libraries.txt" token="@BUILD.NUMBER@" value="${build.number}"/>
    <replace file="${dist.dir}/readme-libraries.txt" token="@BUILD.DATE@" value="${date.long}"/>
    <mkdir dir="${dist.dir}/files/src"/>
    <copy todir="${dist.dir}/files">
      <fileset dir="${base.dir}">
        <!-- src/java -->
        <include name="src/java/**"/>
        <exclude name="src/java/org/aspcfs/modules/industry/spirit/**"/>
        <!-- src/web/jsp -->
        <include name="src/web/jsp/**"/>
        <!-- master.properties -->
        <include name="master.properties"/>
        <include name="home.properties.example"/>
      </fileset>
    </copy>
    <!-- Create the distributable .zip file -->
    <zip destfile="${dist.dir}/${zip.dir}_source.zip">
      <!-- main directory -->
      <zipfileset dir="${dist.dir}" includes="README.txt" prefix="${zip.dir}"/>
      <zipfileset dir="${base.dir}" includes="LICENSE.txt" prefix="${zip.dir}"/>
      <zipfileset dir="${base.dir}" includes="build.xml" prefix="${zip.dir}"/>
      <zipfileset dir="${base.dir}" includes="build.cleanup" prefix="${zip.dir}"/>
      <zipfileset dir="${dist.dir}/files" includes="master.properties" prefix="${zip.dir}"/>
      <!-- sub directories: prefs -->
      <zipfileset dir="pref/jedit" prefix="${zip.dir}/pref/jedit"/>
      <zipfileset dir="pref/cfs/notifier" prefix="${zip.dir}/pref/cfs/notifier"/>
      <zipfileset dir="pref/cfs/system" prefix="${zip.dir}/pref/cfs/system"/>
      <zipfileset dir="pref/cfs/transfer" prefix="${zip.dir}/pref/cfs/transfer"/>
      <zipfileset dir="pref/cfs/source" includes="MANIFEST.MF" fullpath="${zip.dir}/pref/cfs/war/MANIFEST.MF"/>
      <!-- sub directories: src/jasper_reports -->
      <zipfileset dir="src/jasper_reports" prefix="${zip.dir}/src/jasper_reports"/>
      <!-- sub directories: src/java -->
      <zipfileset dir="${dist.dir}/files/src/java" prefix="${zip.dir}/src/java"/>
      <!-- sub directories: src/sql -->
      <zipfileset dir="src/sql/postgresql" includes="new_*.sql" prefix="${zip.dir}/src/sql/postgresql"/>
      <zipfileset dir="src/sql/postgresql/upgrade" includes="*.sql,*.txt" prefix="${zip.dir}/src/sql/postgresql/upgrade"/>
      <zipfileset dir="src/sql/init" includes="*.sql, *.xml, *.bsh" prefix="${zip.dir}/src/sql/init"/>
      <zipfileset dir="src/sql/upgrade" includes="*.bsh" prefix="${zip.dir}/src/sql/upgrade"/>
      <!-- sub directories: src/web/images -->
      <zipfileset dir="src/web/images" prefix="${zip.dir}/src/web/images"/>
      <!-- sub directories: src/web/WEB-INF -->
      <zipfileset dir="src/web/WEB-INF" excludes="keystore" prefix="${zip.dir}/src/web/WEB-INF"/>
      <!-- sub directories: src/web/css -->
      <zipfileset dir="src/web/css" prefix="${zip.dir}/src/web/css"/>
      <!-- sub directories: src/web/html -->
      <zipfileset dir="src/web/html" prefix="${zip.dir}/src/web/html"/>
      <!-- sub directories: src/web/javascript -->
      <zipfileset dir="src/web/javascript" prefix="${zip.dir}/src/web/javascript"/>
      <!-- sub directories: src/web/jsp -->
      <zipfileset dir="${dist.dir}/files/src/web" prefix="${zip.dir}/src/web"/>
      <!-- language files -->
      <zipfileset dir="src/languages" prefix="${zip.dir}/src/languages"/>
      <zipfileset dir="src/fonts" prefix="${zip.dir}/src/fonts"/>
    </zip>
    <!-- Libraries -->
    <zip destfile="${dist.dir}/${zip.dir}_libraries.zip">
      <zipfileset dir="${dist.dir}" includes="readme-libraries.txt" fullpath="${zip.dir}/readme-libraries.txt"/>
      <zipfileset dir="lib" prefix="${zip.dir}/lib"/>
    </zip>
    <!-- delete temporary files -->
    <delete>
      <fileset dir="${dist.dir}" includes="*.txt"/>
    </delete>
    <delete dir="${dist.dir}/files"/>
  </target>

  <!-- Create tools distribution -->
  <target name="tools" description="Compile, build, and generate tools archive" depends="deploy,tools.archive">
  </target>

  <target name="tools.archive">
    <property name="zip.dir" value="centric_crm_tools"/>
    <property name="tools.version" value="4.1"/>
    <delete dir="${dist.dir}"/>
    <mkdir dir="${dist.dir}"/>
    <!-- Update the build number -->
    <copy file="${base.dir}/pref/cfs/tools/readme.txt" todir="${dist.dir}"
          verbose="true"/>
    <buildnumber file="tools.number"/>
    <replace file="${dist.dir}/readme.txt"
             token="@BUILD.NUMBER@" value="${build.number}"/>
    <replace file="${dist.dir}/readme.txt"
             token="@BUILD.DATE@" value="${date.long}"/>
    <copy file="${base.dir}/pref/cfs/transfer/import-mappings.xml"
          todir="${dist.dir}" verbose="true"/>
    <!-- Ignore certain code when zipping -->
    <mkdir dir="${dist.dir}/files/src"/>
    <copy todir="${dist.dir}/files" verbose="true">
      <fileset dir="${base.dir}">
        <!-- src/java -->
        <include name="src/java/org/aspcfs/utils/CRMConnection.java"/>
        <include name="src/java/org/aspcfs/apps/transfer/writer/cfshttpxmlwriter/CFSHttpXMLWriter.java"/>
        <include name="src/java/org/aspcfs/apps/transfer/DataImportHandler.java"/>
        <include name="src/java/org/aspcfs/apps/transfer/Transfer.java"/>
        <include name="src/java/org/aspcfs/utils/XMLUtils.java"/>
        <include name="src/java/org/aspcfs/utils/HTTPUtils.java"/>
        <include name="src/java/org/aspcfs/utils/HttpsTrustManager.java"/>
        <include name="src/java/org/aspcfs/utils/HttpsHostnameVerifier.java"/>
        <include name="src/java/org/aspcfs/utils/HttpsHostnameVerifierDeprecated.java"/>
        <include name="src/java/org/aspcfs/utils/StringUtils.java"/>
        <include name="src/java/org/aspcfs/utils/ObjectUtils.java"/>
        <include name="src/java/org/aspcfs/utils/PasswordHash.java"/>
        <include name="src/java/org/aspcfs/apps/transfer/DataRecord.java"/>
        <include name="src/java/org/aspcfs/apps/transfer/DataField.java"/>
        <include name="src/java/org/aspcfs/apps/transfer/DataWriter.java"/>
        <include name="src/java/org/aspcfs/apps/transfer/DataReader.java"/>
        <include name="src/java/org/aspcfs/modules/service/base/TransactionStatus.java"/>
        <include name="src/java/org/aspcfs/modules/service/base/RecordList.java"/>
        <include name="src/java/org/aspcfs/modules/service/base/Record.java"/>
      </fileset>
    </copy>
    <mkdir dir="${dist.dir}/files/classes"/>
    <javac srcdir="${dist.dir}/files/src/java"
           destdir="${dist.dir}/files/classes" verbose="off" deprecation="off"
           source="10" target="10"
           includeantruntime="true">
      <classpath>
        <path refid="cfs2.classpath"/>
      </classpath>
    </javac>
    <jar jarfile="${dist.dir}/${zip.dir}-${tools.version}.jar"
         basedir="${dist.dir}/files/classes"/>
    <!-- Create the distributable .zip file -->
    <zip destfile="${dist.dir}/${zip.dir}.zip">
      <!-- main directory -->
      <zipfileset dir="${dist.dir}" includes="readme.txt" prefix="${zip.dir}"/>
      <zipfileset dir="${dist.dir}" includes="import-mappings.xml"
                  prefix="${zip.dir}"/>
      <zipfileset dir="${dist.dir}" includes="${zip.dir}-${tools.version}.jar"
                  prefix="${zip.dir}"/>
    </zip>
    <!-- delete temporary files -->
    <delete>
      <fileset dir="${dist.dir}" includes="*.txt"/>
    </delete>
    <delete dir="${dist.dir}/files"/>
  </target>

  <!-- Remove the build folder -->
  <target name="clean" description="Delete the temporary build folder used by the install" depends="init">
    <delete dir="${build.dir}"/>
    <delete dir="${dist.dir}"/>
  </target>

  <!-- References to development databases -->
  <target name="installgk" depends="init,installgk.execute,install.prepare,installgk.database" description="Gatekeeper database ">
  </target>

  <!-- force execute -->
  <target name="installgk.execute">
    <property name="EXECUTE_GK" value="true"/>
    <property name="DATABASE.NAME" value="${GATEKEEPER.URL}"/>
  </target>

  <!-- execute if using a single development database -->
  <target name="installgk.execute.check" unless="WEBSERVER.ASPMODE">
    <property name="EXECUTE_GK" value="true"/>
  </target>

  <target name="installgk.database" depends="init,install.prepare" if="EXECUTE_GK" description="Create tables for gatekeeper database">
    <echo message="Initializing schema..."/>
    <sql driver="${GATEKEEPER.DRIVER}" url="${GATEKEEPER.URL}" userid="${GATEKEEPER.USER}" password="${GATEKEEPER.PASSWORD}">
      <classpath>
        <path refid="cfs2.classpath"/>
      </classpath>
      <transaction src="${src.sql.dir}/${GATEKEEPER.DBTYPE}/new_gatekeeper.sql"/>
    </sql>
  </target>

  <target name="install.gk" depends="installgk.execute.check,installgk.database" if="EXECUTE_GK">
    <property name="INSTALL.NEXT_ID" value="1"/>
  </target>

  <target name="installgk.abortOnDB">
    <condition property="ABORT">
      <or>
        <equals arg1="${GATEKEEPER.DBTYPE}" arg2="daffodildb" casesensitive="false" trim="true"/>
        <equals arg1="${GATEKEEPER.DBTYPE}" arg2="derby" casesensitive="false" trim="true"/>
      </or>
    </condition>
    <fail if="ABORT">Step of gatekeeper installation complete, now execute the
      next installgk# script.
    </fail>
  </target>

  <target name="install.prepare.dbname" unless="DATABASE.NAME">
    <!-- Ask for the database name -->
    <input message="Enter database name: " addproperty="DATABASE.NAME"/>
    <!-- Display all information about database here, except password -->
    <echo message="Driver: ${SITE.DRIVER}"/>
    <echo message="URL: ${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"/>
    <echo message="Username: ${SITE.USER}"/>
  </target>

  <!-- Ask about gatekeeper record -->
  <target name="install.gatekeeper.init" depends="init" if="WEBSERVER.ASPMODE">
    <input message="Add a gatekeeper site record? " validargs="y,n" addproperty="SKIP.GATEKEEPER"/>
    <condition property="DATABASE.DO_GATEKEEPER">
      <equals arg1="y" arg2="${SKIP.GATEKEEPER}"/>
    </condition>
  </target>

  <!-- Prepare files for any database type -->
  <target name="install.prepare.init" depends="init,install.prepare.dbname">
    <!-- Verify database can be overwritten -->
    <input message="The database '${DATABASE.NAME}' will be modified and must already exist, continue? " validargs="y,n" addproperty="DATABASE.DELETE"/>
    <condition property="ABORT">
      <equals arg1="n" arg2="${DATABASE.DELETE}"/>
    </condition>
    <fail if="ABORT">Build aborted by user.</fail>
    <!-- Determine the database to execute the compatible tasks -->
    <!-- Copy template files to be used -->
    <delete dir="${build.sql.dir}" failonerror="false"/>
    <mkdir dir="${build.sql.dir}"/>
    <copy todir="${build.sql.dir}">
      <fileset dir="${src.sql.dir}/init">
        <include name="*.sql"/>
      </fileset>
    </copy>
  </target>

  <target name="install.abortOnDB">
    <condition property="ABORT">
      <or>
        <equals arg1="${SITE.DBTYPE}" arg2="daffodildb" casesensitive="false" trim="true"/>
        <equals arg1="${SITE.DBTYPE}" arg2="derby" casesensitive="false" trim="true"/>
      </or>
    </condition>
    <fail if="ABORT">This database type requires additional ant installdb
      commands.

      SOLUTION: Now execute "ant installdb${INSTALL.NEXT_ID}"
    </fail>
  </target>

  <target name="install.prepare" depends="install.prepare.init">
    <echo message="SQL files prepared for database type: ${SITE.DBTYPE}"/>
  </target>

  <target name="install.database" depends="init,install.prepare">
    <property name="INSTALL.NEXT_ID" value="2"/>
    <echo message="Building database"/>
    <!-- Create database and initialize data -->
    <sql driver="${SITE.DRIVER}" url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}" userid="${SITE.USER}" password="${SITE.PASSWORD}">
      <classpath>
        <path refid="cfs2.classpath"/>
      </classpath>
      <!-- base data -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_cdb.sql"/>
      <!-- opportunities -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_opportunity.sql"/>
      <!-- project management -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_project.sql"/>
      <!-- product catalog -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_product.sql"/>
      <!-- service contracts and assets -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_service_contract.sql"/>
      <!-- tickets -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_tms.sql"/>
      <!-- quotes, orders -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_quote.sql"/>
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_order.sql"/>
      <!-- custom fields -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_custom_field.sql"/>
      <!-- communications manager -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_campaign.sql"/>
      <!-- help -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_help.sql"/>
      <!-- synchronization api -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_sync.sql"/>
      <!-- autoguide module -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_autoguide.sql"/>
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_email_account.sql"/>
      <!--
      <transaction src="${build.sql.dir}/autoguide.sql"/>
      -->
      <!-- revenue manager -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_revenue.sql"/>
      <!-- task management -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_task.sql"/>
      <!-- document management -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_documents.sql"/>
      <!-- framework data -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_workflow.sql"/>
      <!-- additional fields -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_tms_append_fields.sql"/>
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_quote_adjustment.sql"/>
      <!-- contact and account history -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_history.sql"/>
      <!-- action plans -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_actionplan.sql"/>
      <!--knowledge base-->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_knowledgebase.sql"/>
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_netapp.sql"/>
      <!-- web site -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_website.sql"/>
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_graph.sql"/>
    </sql>
    <delete dir="${build.sql.dir}" failonerror="false"/>
  </target>

  <!-- Insert required default data -->
  <target name="install.system" depends="init,install.prepare,taskdef.upgradeDatabase">
    <property name="INSTALL.NEXT_ID" value="3"/>
    <upgradeDatabase sitecode="${SITE.APPCODE}" driver="${SITE.DRIVER}" url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}" user="${SITE.USER}" password="${SITE.PASSWORD}" servletJar="${servletJar}" fileLibraryPath="${CENTRIC_FILELIBRARY}" baseFile="${src.sql.dir}${fs}init${fs}database.bsh" specificDatabase="${DATABASE.NAME}">
    </upgradeDatabase>
    <upgradeDatabase sitecode="${SITE.APPCODE}" driver="${SITE.DRIVER}" url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}" user="${SITE.USER}" password="${SITE.PASSWORD}" servletJar="${servletJar}" fileLibraryPath="${CENTRIC_FILELIBRARY}" baseFile="${src.sql.dir}${fs}init${fs}sync.bsh" specificDatabase="${DATABASE.NAME}">
    </upgradeDatabase>
  </target>

  <!-- Install Sync API -->
  <target name="install.syncapi" depends="init,install.prepare,taskdef.upgradeDatabase">
    <upgradeDatabase sitecode="${SITE.APPCODE}" driver="${SITE.DRIVER}" url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}" user="${SITE.USER}" password="${SITE.PASSWORD}" servletJar="${servletJar}" fileLibraryPath="${CENTRIC_FILELIBRARY}" baseFile="${src.sql.dir}${fs}init${fs}sync.bsh" specificDatabase="${DATABASE.NAME}">
    </upgradeDatabase>
    <upgradeDatabase sitecode="${SITE.APPCODE}" driver="${SITE.DRIVER}" url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}" user="${SITE.USER}" password="${SITE.PASSWORD}" servletJar="${servletJar}" fileLibraryPath="${CENTRIC_FILELIBRARY}" prefsPath="${pref.dir}" baseFile="${src.sql.dir}${fs}init${fs}sync-mappings.bsh" specificDatabase="${DATABASE.NAME}">
    </upgradeDatabase>
  </target>


  <!-- Install permissions -->
  <target name="install.permissions" depends="init,install.prepare">
    <echo message="Process file: ${src.sql.dir}${fs}init${fs}permissions_${LOCALE.NAME}.xml"/>
    <java classname="org.aspcfs.apps.transfer.Transfer" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${build.lib.dir}">
          <include name="*.jar"/>
        </fileset>
      </classpath>
      <sysproperty key="processConfigFile" value="${src.sql.dir}${fs}init${fs}permissions_${LOCALE.NAME}.xml"/>
      <sysproperty key="driver" value="${SITE.DRIVER}"/>
      <sysproperty key="url" value="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"/>
      <sysproperty key="user" value="${SITE.USER}"/>
      <sysproperty key="pass" value="${SITE.PASSWORD}"/>
      <arg value="${src.sql.dir}${fs}init${fs}permissions-dataimport.xml"/>
    </java>
  </target>

  <!-- Upgrade help contents by deleting all help and then inserting -->
  <target name="upgradedb.help" depends="init,install.prepare,install.deletehelp,install.help"/>

  <!-- Upgrade help contents by deleting all help and then inserting -->
  <target name="install.deletehelp" depends="init,install.prepare">
    <echo message="Deleting existing help contents..."/>
    <!-- Delete the old help -->
    <sql driver="${SITE.DRIVER}" url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}" userid="${SITE.USER}" password="${SITE.PASSWORD}">
      <classpath>
        <path refid="cfs2.classpath"/>
      </classpath>
      <transaction>DROP TABLE help_tips</transaction>
      <transaction>DROP TABLE help_notes</transaction>
      <transaction>DROP TABLE help_business_rules</transaction>
      <transaction>DROP TABLE help_faqs</transaction>
      <transaction>DROP TABLE help_related_links</transaction>
      <transaction>DROP TABLE help_features</transaction>
      <transaction>DROP TABLE lookup_help_features</transaction>
      <transaction>DROP TABLE help_tableofcontentitem_links</transaction>
      <transaction>DROP TABLE help_tableof_contents</transaction>
      <transaction>DROP TABLE help_contents</transaction>
      <transaction>DROP TABLE help_module</transaction>
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_help.sql"/>
    </sql>
  </target>

  <!-- Install help contents into blank database -->
  <target name="install.help" depends="init,install.prepare">
    <echo message="Installing help contents from: ${src.sql.dir}${fs}init${fs}help.xml"/>
    <java classname="org.aspcfs.apps.help.ImportHelp" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${build.lib.dir}">
          <include name="*.jar"/>
        </fileset>
      </classpath>
      <arg value="${src.sql.dir}${fs}init${fs}help.xml"/>
      <arg value="${SITE.DRIVER}"/>
      <arg value="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"/>
      <arg value="${SITE.USER}"/>
      <arg value="${SITE.PASSWORD}"/>
    </java>
  </target>

  <target name="install.lookup" depends="init,install.prepare.dbname,install.prepare">
    <echo message="Installing lookuplists: lookuplists_${LOCALE.NAME}.xml"/>
    <java classname="org.aspcfs.apps.lookuplists.ImportLookupLists" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${build.lib.dir}">
          <include name="*.jar"/>
        </fileset>
      </classpath>
      <arg value="${pref.dir}${fs}cfs${fs}system${fs}lookuplists_${LOCALE.NAME}.xml"/>
      <arg value="${SITE.DRIVER}"/>
      <arg value="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"/>
      <arg value="${SITE.USER}"/>
      <arg value="${SITE.PASSWORD}"/>
    </java>
  </target>

  <!-- Add a site record to the sites table -->
  <target name="install.addsite" depends="init,install.prepare.dbname,install.gatekeeper.init,taskdef.upgradeDatabase" if="DATABASE.DO_GATEKEEPER">
    <input message="Please enter the virtual host URL for this site, ex &lt;site&gt;.aspcfs.com or 127.0.0.1: " addproperty="SITE.VIRTUAL_HOST"/>
    <input message="Enable site?" addproperty="SITE.CRON" validargs="y,n"/>
    <upgradeDatabase sitecode="${SITE.APPCODE}" driver="${GATEKEEPER.DRIVER}" url="${GATEKEEPER.URL}" user="${GATEKEEPER.USER}" password="${GATEKEEPER.PASSWORD}" servletJar="${servletJar}" fileLibraryPath="${CENTRIC_FILELIBRARY}" baseFile="${src.sql.dir}${fs}init${fs}addsite_gk.bsh" params="APPCODE=${SITE.APPCODE}|VIRTUAL_HOST=${SITE.VIRTUAL_HOST}|DATABASE_URL=${SITE.URL}${DATABASE.NAME}${SITE.APPEND}|DATABASE_NAME=${DATABASE.NAME}|DATABASE_USER=${SITE.USER}|DATABASE_PASSWORD=${SITE.PASSWORD}|DATABASE_DRIVER=${SITE.DRIVER}|CRON=${SITE.CRON}|LANGUAGE=${SYSTEM.LANGUAGE}">
    </upgradeDatabase>
  </target>

  <!-- Copy the default .XML preferences for this system -->
  <target name="install.copyprefs" depends="init,install.prepare.dbname,taskdef.upgradeDatabase,taskdef.jasper">
    <mkdir dir="${CENTRIC_FILELIBRARY}/${DATABASE.NAME}"/>
    <copy todir="${CENTRIC_FILELIBRARY}/${DATABASE.NAME}">
      <fileset dir="${pref.dir}/cfs/system">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <!-- Install the workflow.xml to the database -->
    <upgradeDatabase sitecode="${SITE.APPCODE}" driver="${SITE.DRIVER}" url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}" user="${SITE.USER}" password="${SITE.PASSWORD}" servletJar="${servletJar}" fileLibraryPath="${CENTRIC_FILELIBRARY}" baseFile="${src.sql.dir}${fs}init${fs}workflow.bsh" specificDatabase="${DATABASE.NAME}" locale="${LOCALE.NAME}">
    </upgradeDatabase>
  </target>
  <!-- Delete the preferences from this system -->
  <target name="install.deleteprefs" depends="init,install.prepare.dbname,taskdef.upgradeDatabase,taskdef.jasper">
    <!-- Delete the workflow from the database -->
    <upgradeDatabase sitecode="${SITE.APPCODE}" driver="${SITE.DRIVER}" url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}" user="${SITE.USER}" password="${SITE.PASSWORD}" servletJar="${servletJar}" fileLibraryPath="${CENTRIC_FILELIBRARY}" baseFile="${src.sql.dir}${fs}init${fs}workflow-delete.bsh" specificDatabase="${DATABASE.NAME}">
    </upgradeDatabase>
  </target>

  <!-- Installs a new database -->
  <!-- Split into multiple calls due to embedded database locking -->
	<target name="installdb" depends="init,log.installdb,install.gk,install.abortOnDB,install.database,install.abortOnDB,install.system,install.syncapi,install.lookup,install.permissions,install.help,install.copyprefs,install.addsite" description="Create tables, insert base records and permissions into new database, copy XML files">
  </target>
  <target name="installdb1" depends="init,log.installdb,install.database,install.abortOnDB" description="Create tables, insert base records and permissions into new database, copy XML files">
  </target>
  <target name="installdb2" depends="init,log.installdb,install.prepare.dbname,install.system,install.syncapi,install.abortOnDB" description="Create tables, insert base records and permissions into new database, copy XML files">
  </target>
  <target name="installdb3" depends="init,log.installdb,install.prepare.dbname,install.lookup,install.permissions,install.help,install.copyprefs,install.addsite" description="Create tables, insert base records and permissions into new database, copy XML files">
  </target>

  <!-- Test the database by inserting sample CRM data -->
  <target name="installdb.test" depends="init,install.prepare,taskdef.upgradeDatabase">
    <upgradeDatabase sitecode="${SITE.APPCODE}" driver="${SITE.DRIVER}" url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}" user="${SITE.USER}" password="${SITE.PASSWORD}" servletJar="${servletJar}" fileLibraryPath="${CENTRIC_FILELIBRARY}" baseFile="${src.sql.dir}${fs}init${fs}testDatabase.bsh" specificDatabase="${DATABASE.NAME}">
    </upgradeDatabase>
  </target>


  <!-- Programmatically upgrades installed databases for
the specified appcode and file, runs against the build code,
not the installed code so that scripts can be run before OR after
a site has been deployed -->
  <target name="upgradedb.name" unless="arg1">
    <input message="Enter file to process, include the file extension: " addproperty="arg1"/>
  </target>
  <target name="upgradedb.site" unless="arg2">
    <input message="Enter database to upgrade: " addproperty="arg2"/>
  </target>
  <target name="upgradedb.uptodate">
    <uptodate property="classes.uptodate">
      <srcfiles dir="${src.classes.dir}" includes="**/*.java"/>
      <mapper type="merge" to="${build.lib.dir}/aspcfs.jar"/>
    </uptodate>
  </target>
  <target name="upgradedb" depends="init,log.upgradedb,taskdef.upgradeDatabase,taskdef.jasper,upgradedb.name,upgradedb.site,upgradedb.uptodate,build" description="Upgrades database using the specified script file">
    <fail unless="arg1">Missing arg1 -- the file to process</fail>
    <fail unless="arg2">Missing arg2 -- the database to upgrade</fail>
    <upgradeDatabase sitecode="${GATEKEEPER.APPCODE}" driver="${GATEKEEPER.DRIVER}" url="${GATEKEEPER.URL}" user="${GATEKEEPER.USER}" password="${GATEKEEPER.PASSWORD}" servletJar="${servletJar}" fileLibraryPath="${CENTRIC_FILELIBRARY}" baseFile="${src.sql.dir}${fs}${SITE.DBTYPE}${fs}upgrade${fs}${arg1}" specificDatabase="${arg2}" locale="${LOCALE.NAME}" languagePath="${src.dir}${fs}languages" prefsPath="${pref.dir}" params="mode=upgrade">
    </upgradeDatabase>
  </target>

  <!-- Generate Java Docs -->
  <target name="docs" description="Generate JavaDocs" depends="compile">
    <mkdir dir="${build.docs.dir}"/>
    <javadoc sourcepath="${src.classes.dir}" packagenames="com.*,org.*" destdir="${build.docs.dir}" maxmemory="128m" breakiterator="true" author="true" version="true" excludepackagenames="javax.servlet">
      <tag name="created" description="Date file was created"/>
      <header>Concourse Suite Community Edition</header>
      <footer>Copyright 2001-2006 Concursive Corporation</footer>
      <classpath>
        <path refid="cfs2.classpath"/>
        <!--
        <pathelement location="${SRC_LIB}/aspcfs.jar"/>
        -->
      </classpath>
    </javadoc>
  </target>

  <target name="language">
    <property name="zip.dir" value="centric_crm_language_pack"/>
    <delete dir="${dist.dir}"/>
    <mkdir dir="${dist.dir}"/>
    <!-- Update the build number -->
    <copy file="${base.dir}/src/languages/readme.txt" todir="${dist.dir}" verbose="true"/>
    <buildnumber file="language.number"/>
    <replace file="${dist.dir}/readme.txt" token="@BUILD.NUMBER@" value="${build.number}"/>
    <replace file="${dist.dir}/readme.txt" token="@BUILD.DATE@" value="${date.long}"/>
    <!-- Copy all translatable files -->
    <mkdir dir="${dist.dir}/dictionary"/>
    <copy todir="${dist.dir}/dictionary" verbose="true">
      <fileset dir="${base.dir}/src/languages">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <mkdir dir="${dist.dir}/javascript"/>
    <copy todir="${dist.dir}/javascript" verbose="true">
      <fileset dir="${base.dir}/src/languages">
        <include name="*.js"/>
      </fileset>
    </copy>
    <mkdir dir="${dist.dir}/permissions"/>
    <copy todir="${dist.dir}/permissions" verbose="true">
      <fileset dir="${base.dir}/src/sql/init">
        <include name="permissions_*.xml"/>
      </fileset>
    </copy>
    <mkdir dir="${dist.dir}/data"/>
    <copy todir="${dist.dir}/data" verbose="true">
      <fileset dir="${base.dir}/pref/cfs/system">
        <include name="lookuplists_*.xml"/>
      </fileset>
    </copy>
    <mkdir dir="${dist.dir}/templates"/>
    <copy todir="${dist.dir}/templates" verbose="true">
      <fileset dir="${base.dir}/pref/cfs/system">
        <include name="templates_*.xml"/>
      </fileset>
    </copy>
    <mkdir dir="${dist.dir}/workflow"/>
    <copy todir="${dist.dir}/workflow" verbose="true">
      <fileset dir="${base.dir}/pref/cfs/system">
        <include name="workflow_*.xml"/>
      </fileset>
    </copy>
    <!-- Create the distributable .zip file -->
    <zip destfile="${dist.dir}/${zip.dir}.zip">
      <!-- main directory -->
      <zipfileset dir="${dist.dir}" includes="readme.txt" prefix="${zip.dir}"/>
      <zipfileset dir="${dist.dir}/dictionary" prefix="${zip.dir}/dictionary"/>
      <zipfileset dir="${dist.dir}/javascript" prefix="${zip.dir}/javascript"/>
      <zipfileset dir="${dist.dir}/permissions" prefix="${zip.dir}/permissions"/>
      <zipfileset dir="${dist.dir}/data" prefix="${zip.dir}/data"/>
      <zipfileset dir="${dist.dir}/templates" prefix="${zip.dir}/templates"/>
      <zipfileset dir="${dist.dir}/workflow" prefix="${zip.dir}/workflow"/>
    </zip>
    <!-- delete temporary files -->
    <delete>
      <fileset dir="${dist.dir}" includes="*.txt"/>
    </delete>
  </target>

  <!-- General Contact Importer based on CSV spec -->
  <target name="import.generalcontacts" depends="init">
    <fail unless="arg1">Missing arg1: CSV file to import not specified</fail>
    <fail unless="arg2">Missing arg2: Virtual Host to import to not specified
    </fail>
    <fail unless="arg3">Missing arg3: Import code not specified</fail>
    <mkdir dir="${build.pref.dir}"/>
    <copy file="${pref.dir}/cfs/transfer/import-generalcontacts.xml" todir="${build.pref.dir}" overwrite="true"/>
    <replace file="${build.pref.dir}/import-generalcontacts.xml" token="@PROPERTY.FILE@" value="${pref.dir}/cfs/transfer/import-mappings.xml"/>
    <replace file="${build.pref.dir}/import-generalcontacts.xml" token="@CSV.FILE@" value="${arg1}"/>
    <replace file="${build.pref.dir}/import-generalcontacts.xml" token="@URL@" value="${arg2}"/>
    <replace file="${build.pref.dir}/import-generalcontacts.xml" token="@CODE@" value="${arg3}"/>
    <replace file="${build.pref.dir}/import-generalcontacts.xml" token="@SYSTEM.ID@" value="4"/>
    <java classname="org.aspcfs.apps.transfer.Transfer" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${CENTRIC_HOME}/WEB-INF/lib">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
      <arg value="${build.pref.dir}${fs}import-generalcontacts.xml"/>
    </java>
  </target>

  <!-- Account Contact Importer based on CSV spec -->
  <target name="import.accountcontacts" depends="init">
    <fail unless="arg1">Missing arg1: CSV file to import not specified</fail>
    <fail unless="arg2">Missing arg2: Virtual Host to import to not specified
    </fail>
    <fail unless="arg3">Missing arg3: Import code not specified</fail>
    <mkdir dir="${build.pref.dir}"/>
    <copy file="${pref.dir}/cfs/transfer/import-accountcontacts.xml" todir="${build.pref.dir}" overwrite="true"/>
    <replace file="${build.pref.dir}/import-accountcontacts.xml" token="@PROPERTY.FILE@" value="${pref.dir}/cfs/transfer/import-mappings.xml"/>
    <replace file="${build.pref.dir}/import-accountcontacts.xml" token="@CSV.FILE@" value="${arg1}"/>
    <replace file="${build.pref.dir}/import-accountcontacts.xml" token="@URL@" value="${arg2}"/>
    <replace file="${build.pref.dir}/import-accountcontacts.xml" token="@ID@" value="${arg3}"/>
    <replace file="${build.pref.dir}/import-accountcontacts.xml" token="@CODE@" value="${arg4}"/>
    <replace file="${build.pref.dir}/import-accountcontacts.xml" token="@SYSTEM.ID@" value="4"/>
    <java classname="org.aspcfs.apps.transfer.Transfer" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${CENTRIC_HOME}/WEB-INF/lib">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
      <arg value="${build.pref.dir}${fs}import-accountcontacts.xml"/>
    </java>
  </target>

  <!-- Accounts Importer based on CSV spec -->
  <target name="import.accounts" depends="init">
    <fail unless="arg1">Missing arg1: CSV file to import not specified</fail>
    <fail unless="arg2">Missing arg2: Virtual Host to import to not specified
    </fail>
    <fail unless="arg3">Missing arg3: Import code not specified</fail>
    <mkdir dir="${build.pref.dir}"/>
    <copy file="${pref.dir}/cfs/transfer/import-accounts.xml" todir="${build.pref.dir}" overwrite="true"/>
    <replace file="${build.pref.dir}/import-accounts.xml" token="@PROPERTY.FILE@" value="${pref.dir}/cfs/transfer/import-mappings.xml"/>
    <replace file="${build.pref.dir}/import-accounts.xml" token="@CSV.FILE@" value="${arg1}"/>
    <replace file="${build.pref.dir}/import-accounts.xml" token="@URL@" value="${arg2}"/>
    <replace file="${build.pref.dir}/import-accounts.xml" token="@CODE@" value="${arg3}"/>
    <replace file="${build.pref.dir}/import-accounts.xml" token="@SYSTEM.ID@" value="4"/>
    <java classname="org.aspcfs.apps.transfer.Transfer" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${CENTRIC_HOME}/WEB-INF/lib">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
      <arg value="${build.pref.dir}${fs}import-accounts.xml"/>
    </java>
  </target>


  <!-- Test the XML HTTP API -->
  <target name="import.unittest" depends="init">
    <fail unless="arg2">Missing arg2: Virtual Host to import to not specified
    </fail>
    <fail unless="arg3">Missing arg3: Import code not specified</fail>
    <mkdir dir="${build.pref.dir}"/>
    <copy file="${pref.dir}/cfs/transfer/import-unittest.xml" todir="${build.pref.dir}" overwrite="true"/>
    <replace file="${build.pref.dir}/import-unittest.xml" token="@URL@" value="${arg2}"/>
    <replace file="${build.pref.dir}/import-unittest.xml" token="@CODE@" value="${arg3}"/>
    <replace file="${build.pref.dir}/import-unittest.xml" token="@SYSTEM.ID@" value="4"/>
    <java classname="org.aspcfs.apps.transfer.Transfer" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${CENTRIC_HOME}/WEB-INF/lib">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
      <arg value="${build.pref.dir}${fs}import-unittest.xml"/>
    </java>
  </target>


  <!-- MISC STUFF TO GO THROUGH (AND MOVE SOMEWHERE ELSE) -->
  <target name="run.databasetest" depends="init,install.prepare">
    <java classname="org.aspcfs.apps.test.Database" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <pathelement location="${CENTRIC_HOME}/WEB-INF/lib/aspcfs.jar"/>
        <pathelement location="${CENTRIC_HOME}/WEB-INF/lib/darkhorseventures.jar"/>
      </classpath>
      <sysproperty key="file" value="${arg1}"/>
      <sysproperty key="driver" value="${SITE.DRIVER}"/>
      <sysproperty key="url" value="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"/>
      <sysproperty key="user" value="${SITE.USER}"/>
      <sysproperty key="pass" value="${SITE.PASSWORD}"/>
    </java>
  </target>

  <!-- Run Vehicle Import -->
  <target name="run.parsekbb" depends="init,install.prepare">
    <java classname="org.aspcfs.modules.media.autoguide.utils.ParseKBB" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <pathelement location="${CENTRIC_HOME}/WEB-INF/lib/aspcfs.jar"/>
        <pathelement location="${CENTRIC_HOME}/WEB-INF/lib/darkhorseventures.jar"/>
      </classpath>
      <sysproperty key="file" value="${arg1}"/>
      <sysproperty key="driver" value="${SITE.DRIVER}"/>
      <sysproperty key="url" value="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"/>
      <sysproperty key="user" value="${SITE.USER}"/>
      <sysproperty key="pass" value="${SITE.PASSWORD}"/>
    </java>
  </target>


  <!-- Test the EDIT transaction server -->
  <target name="run.edit" depends="init">
    <java classname="org.aspcfs.modules.healthcare.edit.apps.HttpPostTransaction" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${CENTRIC_HOME}/WEB-INF/lib">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
      <arg value="${arg1}"/>
      <arg value="${arg2}"/>
    </java>
  </target>

  <!-- See if files are up-to-date so only new files are installed during development -->
  <target name="unittests.classes.prepare">
    <uptodate property="unittests.classes.uptodate">
      <srcfiles dir="${unittests.src.dir}" includes="**/*.java"/>
      <mapper type="merge" to="${unittests.build.lib.dir}/unit-tests.jar"/>
    </uptodate>
  </target>

  <!-- Compile the Unit tests source code -->
  <target name="unittests.jar" depends="unittests.classes.prepare" unless="unittests.classes.uptodate">
    <delete dir="${unittests.build.dir}" failonerror="false"/>
    <mkdir dir="${unittests.build.dir}"/>
    <mkdir dir="${unittests.build.classes.dir}"/>
    <mkdir dir="${unittests.build.lib.dir}"/>
    <javac srcdir="${unittests.src.dir}" destdir="${unittests.build.classes.dir}" verbose="off" deprecation="off" fork="true" memoryInitialSize="168m" memoryMaximumSize="168m">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${build.lib.dir}">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
    </javac>
    <jar jarfile="${unittests.build.lib.dir}/unit-tests.jar" basedir="${unittests.build.classes.dir}" includes="**/*.class"/>
  </target>

  <!-- Run Unit tests -->
  <target name="unittests.runner" depends="init,unittests.jar">
    <delete dir="${unittests.reports.dir}" failonerror="false"/>
    <mkdir dir="${unittests.reports.dir}"/>
    <echo message="+-----------------------"/>
    <echo message="| Tests are runnitng... See full-length results in '${unittests.reports.dir}'."/>
    <echo message="+---------------------"/>
    <junit printsummary="yes" haltonfailure="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${build.lib.dir}">
          <include name="**/*.jar"/>
        </fileset>
        <fileset dir="${unittests.build.lib.dir}">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
      <batchtest fork="yes" todir="${unittests.reports.dir}">
        <formatter type="xml"/>
        <fileset dir="${unittests.src.dir}">
          <include name="**/*Test.java"/>
          <exclude name="**/AllTests.java"/>
          <exclude name="**/*TestSuite.java"/>
        </fileset>
      </batchtest>
    </junit>
  </target>

  <target name="unittests" depends="init,dev,unittests.runner" description="Deploy without deleting previously compiled source and run Unit tests">
  </target>

  <!-- Register Centric's Web Service with Axis -->
  <target name="ws" depends="init">
    <fail unless="AXIS_HOME">Web Services registration aborted

      SOLUTION:

      Set an environment variable for AXIS_HOME or add AXIS_HOME to
      home.properties

    </fail>
    <fail unless="AXIS.PORT">Web Services registration aborted

      SOLUTION:

      Uncomment AXIS.PORT in build.properties:

      ${build.config.filename}

    </fail>
    <fail unless="AXIS.HOST">Web Services registration aborted

      SOLUTION:

      Uncomment AXIS.HOST in build.properties:

      ${build.config.filename}

    </fail>
    <fail unless="AXIS.WEBAPP">Web Services registration aborted

      SOLUTION:

      Uncomment AXIS.WEBAPP in build.properties:

      ${build.config.filename}

    </fail>

    <available file="${AXIS_HOME}/WEB-INF/lib/aspcfs.jar" property="ws.aspcfs.present"/>
    <fail unless="ws.aspcfs.present">Web Services registration aborted

      SOLUTION:

      Execute "ant deploy" first

    </fail>

    <path id="axis.classpath">
      <fileset dir="${AXIS_HOME}/WEB-INF/lib">
        <include name="*.jar"/>
        <!--
        <include name="axis.jar"/>
        <include name="axis-ant.jar"/>
        <include name="commons-discovery-0.2.jar"/>
        <include name="commons-logging-1.0.4.jar"/>
        <include name="log4j-1.2.8.jar"/>
        <include name="xml-apis.jar"/>
        <include name="xercesImpl.jar"/>
        <include name="wsdl4j-1.5.1.jar"/>
        <include name="aspcfs.jar"/>
        <include name="darkhorseventures.jar"/>
        -->
      </fileset>
      <fileset dir="${CATALINA_HOME}/common/lib">
        <include name="servlet-api.jar"/>
        <include name="jaxrpc.jar"/>
        <include name="saaj.jar"/>
      </fileset>
    </path>
    <taskdef resource="axis-tasks.properties" classpathref="axis.classpath"/>
    <axis-admin port="${AXIS.PORT}" hostname="${AXIS.HOST}" failonerror="true" servletpath="${AXIS.WEBAPP}/services/AdminService" debug="true" xmlfile="${base.dir}/deploy.wsdd"/>
  </target>

  <!-- Database Importer based on CSV spec -->
  <target name="import.database" depends="init">
    <fail unless="arg1">Missing arg1: Virtual Host to import from not specified
    </fail>
    <fail unless="arg2">Missing arg2: User not specified</fail>
    <fail unless="arg3">Missing arg3: Password not specified</fail>
    <mkdir dir="${build.pref.dir}"/>
    <copy file="${pref.dir}/cfs/transfer/import-database.xml" todir="${build.pref.dir}" overwrite="true"/>
    <replace file="${build.pref.dir}/import-database.xml" token="@DRIVER@" value="${SITE.DRIVER}"/>
    <replace file="${build.pref.dir}/import-database.xml" token="@URL@" value="${arg1}"/>
    <replace file="${build.pref.dir}/import-database.xml" token="@USER@" value="${arg2}"/>
    <replace file="${build.pref.dir}/import-database.xml" token="@PASSWORD@" value="${arg3}"/>
    <replace file="${build.pref.dir}/import-database.xml" token="@CONFIG.FILE@" value="${pref.dir}/cfs/transfer/import-mappings.xml"/>
    <replace file="${build.pref.dir}/import-database.xml" token="@FILENAME@" value="${arg4}"/>
    <replace file="${build.pref.dir}/import-database.xml" token="@FIELDSEPARATOR@" value=","/>
    <java classname="org.aspcfs.apps.transfer.Transfer" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${CENTRIC_HOME}/WEB-INF/lib">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
      <arg value="${build.pref.dir}${fs}import-database.xml"/>
    </java>
  </target>

  <!-- Database Restore -->
  <target name="restore.database" depends="init">
    <fail unless="arg1">Missing arg1: Restore URL to post to, not specified
    </fail>
    <fail unless="arg2">Missing arg2: Server not specified</fail>
    <fail unless="arg3">Missing arg3: Code not specified</fail>
    <mkdir dir="${build.pref.dir}"/>
    <copy file="${pref.dir}/cfs/transfer/restore-database.xml" todir="${build.pref.dir}" overwrite="true"/>
    <replace file="${build.pref.dir}/restore-database.xml" token="@CONFIG.FILE@" value="${base.dir}/database-backup.xml"/>
    <replace file="${build.pref.dir}/restore-database.xml" token="@URL@" value="${arg1}"/>
    <replace file="${build.pref.dir}/restore-database.xml" token="@ID@" value="${arg2}"/>
    <replace file="${build.pref.dir}/restore-database.xml" token="@CODE@" value="${arg3}"/>
    <replace file="${build.pref.dir}/restore-database.xml" token="@SYSTEM@" value="4"/>
    <java classname="org.aspcfs.apps.transfer.Transfer" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${CENTRIC_HOME}/WEB-INF/lib">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
      <arg value="${build.pref.dir}${fs}restore-database.xml"/>
    </java>
  </target>

  <!-- System Database Importer -->
  <target name="import.system" depends="init">
    <fail unless="arg1">Missing arg1: Virtual Host to import from not specified
    </fail>
    <fail unless="arg2">Missing arg2: User not specified</fail>
    <fail unless="arg3">Missing arg3: Password not specified</fail>
    <fail unless="arg4">Missing arg4: Backup URL to post to, not specified
    </fail>
    <fail unless="arg5">Missing arg5: Server not specified</fail>
    <fail unless="arg6">Missing arg6: Code not specified</fail>
    <mkdir dir="${build.pref.dir}"/>
    <copy file="${pref.dir}/cfs/transfer/import-system.xml" todir="${build.pref.dir}" overwrite="true"/>
    <replace file="${build.pref.dir}/import-system.xml" token="@DRIVER@" value="${SITE.DRIVER}"/>
    <replace file="${build.pref.dir}/import-system.xml" token="@URL@" value="${arg1}"/>
    <replace file="${build.pref.dir}/import-system.xml" token="@USER@" value="${arg2}"/>
    <replace file="${build.pref.dir}/import-system.xml" token="@PASSWORD@" value="${arg3}"/>
    <replace file="${build.pref.dir}/import-system.xml" token="@CONFIG.FILE@" value="${pref.dir}/cfs/transfer/import-mappings.xml"/>
    <replace file="${build.pref.dir}/import-system.xml" token="@URL2@" value="${arg4}"/>
    <replace file="${build.pref.dir}/import-system.xml" token="@ID@" value="${arg5}"/>
    <replace file="${build.pref.dir}/import-system.xml" token="@CODE@" value="${arg6}"/>
    <replace file="${build.pref.dir}/import-system.xml" token="@SYSTEM@" value="4"/>
    <java classname="org.aspcfs.apps.transfer.Transfer" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${CENTRIC_HOME}/WEB-INF/lib">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
      <arg value="${build.pref.dir}${fs}import-system.xml"/>
    </java>
  </target>
</project>
